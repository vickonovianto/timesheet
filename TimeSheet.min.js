!function(e){var t=function(t){var a=e.extend({state:0,toggleCallback:!1,settingCallback:!1},t);this.toggle=function(){a.state=a.state>0?a.state-1:a.state+1,a.toggleCallback&&a.toggleCallback(a.state)},this.set=function(e){a.state=0==e?0:1,a.settingCallback&&a.settingCallback()},this.get=function(){return a.state}},a=function(a){var n=e.extend({dimensions:void 0,sheetData:void 0,toggleCallback:!1,settingCallback:!1},a);n.cells=[],n.initCells=function(){var e=n.dimensions[0],a=n.dimensions[1];if(!(2==n.dimensions.length&&e>0&&a>0))throw new Error("CSheet : wrong dimensions");for(var l=0,s=[];l<e;++l){s=[];for(var i=0;i<a;++i)s.push(new t({state:n.sheetData&&n.sheetData[l]?parseInt(n.sheetData[l][i]):0}));n.cells.push(s)}},n.setFirstRow=function(e){for(let t=0;t<e.length;t++)n.cells[0][t].set(e[t])},n.areaOperate=function(t,a){var l=n.cells.length,s=n.cells[0]?n.cells[0].length:0,i=e.extend({startCell:[0,0],endCell:[l-1,s-1]},t),o=0==l||0==s;if(!(i.startCell[0]>=0&&i.endCell[0]<=l-1&&i.startCell[1]>=0&&i.endCell[1]<=s-1&&i.startCell[0]<=i.endCell[0]&&i.startCell[1]<=i.endCell[1]))throw new Error("CSheet : operation area is invalid");if(!o)for(var r=i.startCell[0];r<=i.endCell[0];++r)for(var d=i.startCell[1];d<=i.endCell[1];++d)"toggle"==a.type?n.cells[r][d].toggle():"set"==a.type&&n.cells[r][d].set(a.state)},n.initCells(),this.toggle=function(e){n.areaOperate(e,{type:"toggle"}),n.toggleCallback&&n.toggleCallback()},this.set=function(e,t){n.areaOperate(t,{type:"set",state:e}),n.settingCallback&&n.settingCallback()},this.setFirstRow=function(e){n.setFirstRow(e)},this.getCellState=function(e){return n.cells[e[0]][e[1]].get()},this.getRowStates=function(e){for(var t=[],a=0;a<n.dimensions[1];++a)t.push(n.cells[e][a].get());return t},this.getSheetStates=function(){for(var e=[],t=0,a=[];t<n.dimensions[0];++t){a=[];for(var l=0;l<n.dimensions[1];++l)a.push(n.cells[t][l].get());e.push(a)}return e}};e.fn.TimeSheet=function(t){var n=e(this);if(!n.is("TBODY"))throw new Error("TimeSheet needs to be bound on a TBODY element");var l=e.extend({data:{},sheetClass:"",start:!1,end:!1,remarks:null},t);if(!l.data.dimensions||2!==l.data.dimensions.length||l.data.dimensions[0]<0||l.data.dimensions[1]<0)throw new Error("TimeSheet : wrong dimensions");var s={startCell:void 0,endCell:void 0},i=new a({dimensions:l.data.dimensions,sheetData:l.data.sheetData?l.data.sheetData:void 0}),o=function(){for(var e="<tr>",t=0;t<=l.data.dimensions[1];++t)e+=0===t||t%2==0?"":'<td colspan="2" title="'+(l.data.colHead[t-1].title?l.data.colHead[t-1].title:"")+'" data-col="'+(t-1)+'" class="TimeSheet-colHead '+(t===l.data.dimensions[1]?"rightMost":"")+'" style="'+(l.data.colHead[t-1].style?l.data.colHead[t-1].style:"")+'">'+l.data.colHead[t-1].name+"</td>";l.remarks&&(e+='<td class="TimeSheet-remarkHead">'+l.remarks.title+"</td>"),e+="</tr>",n.append(e)},r=function(){for(var e=0,t="";e<l.data.dimensions[0];++e){t='<tr class="TimeSheet-row">';for(var a=0;a<=l.data.dimensions[1];++a)t+=0===a?"":'<td class="TimeSheet-cell '+(e===l.data.dimensions[0]-1?"bottomMost ":" ")+(a===l.data.dimensions[1]?"rightMost":"")+'" data-row="'+e+'" data-col="'+(a-1)+'">&nbsp;</td>';l.remarks&&(t+='<td class="TimeSheet-remark '+(e===l.data.dimensions[0]-1?"bottomMost ":" ")+'">'+l.remarks.default+"</td>"),t+="</tr>",n.append(t)}},d=function(e,t){var a=e[0]+e[1],n=t[0]+t[1];return(e[0]-t[0])*(e[1]-t[1])<0?{topLeft:e[0]<t[0]?[e[0],t[1]]:[t[0],e[1]],bottomRight:e[0]<t[0]?[t[0],e[1]]:[e[0],t[1]]}:{topLeft:a<=n?e:t,bottomRight:a>n?e:t}},c=function(){var t=i.getSheetStates();n.find(".TimeSheet-row").each((function(a,n){e(n).find(".TimeSheet-cell").each((function(n,l){var s=e(l);1===t[a][n]?s.addClass("TimeSheet-cell-selected"):0===t[a][n]&&s.removeClass("TimeSheet-cell-selected")}))}))},u=function(){n.find(".TimeSheet-cell-selecting").removeClass("TimeSheet-cell-selecting")},h=function(){n.find(".TimeSheet-remark").each((function(t,a){var n=e(a);n.prop("title",""),n.html(l.remarks.default)}))},f=!1,m=!1,g=null,C=function(){n.undelegate(".umsSheetEvent"),n.delegate(".TimeSheet-cell","mousedown.umsSheetEvent",(function(t){var a=e(t.currentTarget),n=[a.data("row"),a.data("col")];f=!0,function(e,t){s.startCell=t,l.start&&l.start(e)}(t,n)})),n.delegate(".TimeSheet-cell","mouseup.umsSheetEvent",(function(t){if(s.startCell){2===t.button?(t.preventDefault(),t.stopPropagation()):0===t.button&&"function"==typeof g&&g.call(this,t);var a=e(t.currentTarget),n=[(a=e(t.currentTarget)).data("row"),a.data("col")];!function(t,a){var n=e(t.currentTarget),o=e(t.which),r=void 0;1===o[0]?r=1:3===o[0]&&(r=0),f&&n.hasClass("TimeSheet-cell")||m&&n.hasClass("TimeSheet-colHead")?(i.set(r,{startCell:a.topLeft,endCell:a.bottomRight}),u(),c(),l.end&&l.end(t,a)):u(),f=!1,m=!1,s={startCell:void 0,endCell:void 0}}(t,d(s.startCell,n))}})),n.delegate(".TimeSheet-cell","mouseover.umsSheetEvent",(function(t){if(f){var a=e(t.currentTarget),l=[a.data("row"),a.data("col")],i=d(s.startCell,l);!function(t,a,l){var s=e(t.currentTarget);if(f&&s.hasClass("TimeSheet-cell")||m&&s.hasClass("TimeSheet-colHead")){u();for(var i=a[0];i<=l[0];++i)for(var o=a[1];o<=l[1];++o)e(e(n.find(".TimeSheet-row")[i]).find(".TimeSheet-cell")[o]).addClass("TimeSheet-cell-selecting")}}(t,i.topLeft,i.bottomRight)}})),n.delegate("td","contextmenu.umsSheetEvent",(function(e){return e.preventDefault(),e.stopImmediatePropagation(),"function"==typeof g&&g.call(this,e),!1}))};return n.html(""),n.addClass("TimeSheet"),l.sheetClass&&n.addClass(l.sheetClass),o(),r(),c(),C(),{getCellState:function(e){return i.getCellState(e)},getRowStates:function(e){return i.getRowStates(e)},getSheetStates:function(){return i.getSheetStates()},setRemark:function(t,a){""!==e.trim(a)&&e(n.find(".TimeSheet-row")[t]).find(".TimeSheet-remark").prop("title",a).html(a)},clean:function(){i.set(0,{}),c(),h()},setFirstRow:function(e){i.setFirstRow(e),c(),h()},getDefaultRemark:function(){return l.remarks.default},disable:function(){n.undelegate(".umsSheetEvent")},enable:function(){C()},isFull:function(){for(var e=0;e<l.data.dimensions[0];++e)for(var t=0;t<l.data.dimensions[1];++t)if(0===i.getCellState([e,t]))return!1;return!0},attachHandler:function(e){g=e}}}}(jQuery);